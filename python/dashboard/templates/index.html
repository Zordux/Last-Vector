<!doctype html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Last-Vector Dashboard</title>
    <link rel="stylesheet" href="/static/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
    <script defer src="/static/app.js"></script>
  </head>
  <body>
    <header class="topbar">
      <div>
        <h1>Last-Vector Training Dashboard</h1>
        <p class="muted">LAN status: bound to <code>0.0.0.0</code> by default.</p>
      </div>
      <div class="status-row">
        <div class="hw-monitor">
          <span>CPU: <strong id="hwCpu">–</strong>%</span>
          <span>RAM: <strong id="hwRam">–</strong>%</span>
          <span class="muted" id="lastRefreshed">Last refreshed: –</span>
        </div>
        <span class="pill">Runs: {{ run_count }}</span>
        <button id="themeToggle" class="btn" type="button">Toggle theme</button>
      </div>
    </header>

    <main class="layout">
      <aside class="panel sidebar">
        <h2>Runs</h2>
        <input id="runSearch" type="search" placeholder="Search by run-id/date" />
        <ul id="runList" class="run-list">
          {% for run in runs %}
          <li class="run-item" data-run-id="{{ run.run_id }}">
            <button class="run-select {% if loop.first %}active{% endif %}" data-run-target="run-{{ loop.index0 }}" type="button">
              <strong>{{ run.run_id }}</strong>
              <small data-run-id="{{ run.run_id }}" data-field="sidebar-state-progress">{{ run.state }} • progress={{ "%.1f"|format(run.metrics.progress_pct) }}%</small>
              <small data-run-id="{{ run.run_id }}" data-field="sidebar-fps-best">fps={{ "%.1f"|format(run.metrics.fps) }} • best={{ "%.2f"|format(run.metrics.best_reward) }}</small>
              <small data-run-id="{{ run.run_id }}" data-field="sidebar-update">updated={{ run.metrics.last_update }}</small>
            </button>
          </li>
          {% endfor %}
        </ul>
      </aside>

      <section class="panel content">
        <nav class="tabs">
          <button class="tab active" data-tab="details" type="button">Run details</button>
          <button class="tab" data-tab="settings" type="button">Settings / About</button>
        </nav>

        {% if runs|length == 0 %}
        <div class="empty">
          <h2>No runs yet</h2>
          <p class="muted">No run directories were found under <code>runs/</code>.</p>
        </div>
        {% else %}
          {% for run in runs %}
          <article id="run-{{ loop.index0 }}" class="run-panel {% if not loop.first %}hidden{% endif %}" data-content="details">
            <div class="cards">
              <div class="card"><span>State</span>
                <strong data-run-id="{{ run.run_id }}" data-field="state">
                  <span class="status-badge {{ run.state }}"></span>{{ run.state }}
                </strong>
              </div>
              <div class="card"><span>Progress</span>
                <strong data-run-id="{{ run.run_id }}" data-field="progress_pct">{{ "%.1f"|format(run.metrics.progress_pct) }}%</strong>
                <div class="progress-bar">
                  <div class="progress-fill" data-run-id="{{ run.run_id }}" data-field="progress_bar" style="width: {{ run.metrics.progress_pct }}%"></div>
                </div>
              </div>
              <div class="card"><span>Steps</span>
                <strong data-run-id="{{ run.run_id }}" data-field="steps">{{ run.metrics.steps }} / {{ run.metrics.total_steps }}</strong>
              </div>
              <div class="card"><span>FPS</span>
                <strong data-run-id="{{ run.run_id }}" data-field="fps">{{ "%.1f"|format(run.metrics.fps) }}</strong>
              </div>
              <div class="card"><span>Episodes</span>
                <strong data-run-id="{{ run.run_id }}" data-field="episodes">{{ run.metrics.episodes }}</strong>
              </div>
              <div class="card"><span>Latest R / Len</span>
                <strong data-run-id="{{ run.run_id }}" data-field="latest_r_len">{{ "%.3f"|format(run.metrics.latest_reward) }} / {{ "%.1f"|format(run.metrics.latest_ep_len) }}</strong>
              </div>
              <div class="card"><span>Best score</span>
                <strong data-run-id="{{ run.run_id }}" data-field="best_score">{{ "%.3f"|format(run.best_model_info.score) }}</strong>
              </div>
              <div class="card"><span>Last update</span>
                <strong data-run-id="{{ run.run_id }}" data-field="last_update">{{ run.metrics.last_update }}</strong>
              </div>
            </div>

            <div class="split">
              <section class="subpanel">
                <h3>Training curves (recent)</h3>
                {% if run.series.steps|length == 0 %}
                  <p class="muted">No metrics.csv data available yet.</p>
                {% else %}
                  <canvas id="chart-{{ loop.index0 }}" data-run-id="{{ run.run_id }}" height="200"></canvas>
                  <script type="application/json" id="series-data-{{ loop.index0 }}">{{ run.series | tojson }}</script>
                  <div class="table-wrap">
                    <table class="mini-table">
                      <thead>
                        <tr><th>Step</th><th>Reward</th><th>Ep Len</th><th>Kills</th></tr>
                      </thead>
                      <tbody>
                        {% for row in run.series.recent_rows %}
                        <tr>
                          <td>{{ row.step }}</td>
                          <td>{{ "%.3f"|format(row.reward) }}</td>
                          <td>{{ "%.2f"|format(row.episode_length) }}</td>
                          <td>{{ "%.2f"|format(row.kills) }}</td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                {% endif %}

                <h3>Checkpoints</h3>
                {% if run.checkpoints|length == 0 %}
                  <p class="muted">No checkpoints found.</p>
                {% else %}
                  <ul class="plain-list">
                    {% for ckpt in run.checkpoints %}
                    <li>{{ ckpt }}</li>
                    {% endfor %}
                  </ul>
                {% endif %}
              </section>

              <section class="subpanel">
                <h3>Best model</h3>
                <p class="muted">Path: <code>{{ run.best_model_info.path }}</code></p>
                <p class="muted">Best score: <strong>{{ "%.3f"|format(run.best_model_info.score) }}</strong></p>

                <h3>TensorBoard</h3>
                {% if run.tensorboard_cmd %}
                  <p class="muted">Cmd: <code>{{ run.tensorboard_cmd }}</code></p>
                {% else %}
                  <p class="muted">TensorBoard logs unavailable.</p>
                {% endif %}
                <p class="muted">Link: <a href="{{ run.tensorboard_link }}" target="_blank" rel="noopener">{{ run.tensorboard_link }}</a></p>

                <h3>Recent logs</h3>
                {% if run.train_log_lines|length == 0 %}
                  <p class="muted">No train.log found.</p>
                {% else %}
                  <pre class="log-box">{{ run.train_log_lines|join('\n') }}</pre>
                {% endif %}
                {% if run.error_log_lines|length > 0 %}
                  <h4>Last error</h4>
                  <pre class="log-box error">{{ run.error_log_lines|join('\n') }}</pre>
                {% endif %}
              </section>
            </div>
          </article>
          {% endfor %}

          <article class="run-panel hidden" data-content="settings">
            <h2>Settings / About</h2>
            <p>This dashboard is intentionally lightweight and server-rendered.</p>
            <ul>
              <li>Host default: <code>0.0.0.0</code> (LAN)</li>
              <li>Gracefully handles empty runs and parse errors.</li>
              <li>No heavy frontend framework dependencies.</li>
            </ul>
          </article>
        {% endif %}
      </section>
    </main>
  </body>
</html>
